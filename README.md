# Разработка линейной модели для предсказания стоимости автомобиля и создание FastAPI веб-сервиса для ее деплоймента

Данный проект выполнен в рамках курса «Машинное обучение» магистерской программы НИУ ВШЭ [«Машинное обучение и высоконагруженные системы»](https://www.hse.ru/ma/mlds/).

## Задача

На основе предоставленных историченных данных разработать линейную модель для предсказания стоимости автомобиля и создать FastAPI веб-сервис для ее деплоймента.

Целевые ML-метрики модели: `r2` и `MSE`. 
Целевая бизнес-метрика модели: доля предсказаний, отличающихся от реальных цен не более чем на 10% (в любую сторону).   

В веб-сервисе должны быть реализованы две функции:

1. предсказание стоимости на одном объекте, полученном в формате `json`
2. предсказание на нескольких объектах, полученных в форме csv-файла

## Предоставленные данные

Данные о характеристиках автомобилей и их стоимости в формате двух файлов: `cars_train.csv` и `cars_test.csv`.

## Этапы работы на проектом

Работа над проектом включала пять этапов:

1. Загрузка, первичное изучение и предобработка данных
2. EDA
3. ML-этап
4. Feature Engineering
5. Разработка и тестирование веб-сервиса

## 1. Загрузка, первичное изучение и предобработка данных

На данном этапе мы загрузили данные и провели их первичное изучение (первые и последние объекты, статистики и общая информация, пропуски, дубликаты)

По итогам первичного изучения данных мы установили:

- в датасете трейн есть дубликаты (объекты с одинаковым признаковым описанием)
- в обоих датасетах в значениях 5 столбцов (`mileage`, `engine`, `max_power`, `torque` и `seats`) есть пропуски

На основе сделанных наблюдений мы:

- удалили дубликаты;
- заполнили пропуски медианой
- убрали единицы измерения в значениях признаков `mileage`, `engine` и `max_power` и привели их типы данных к `int`
- раздели значения признака `torque` на два признака: `torque` и `max_torque_rpm`

## 2. EDA

На данном этапе мы проанализировали:

- попарные распределения числовых признаков и целевой переменной для трейна и теста
- тепловую карту попарных корреляций признаков и целевой переменной для трейна
- графики оценки распределения ядра и диаграммы размаха

По результатам анализа мы установили:

### Попарные распределения числовых признаков и целевой переменной

- распределения числовых признаков и целевой переменной на трейне и тесте похожи, так что можно ожидать, что модель м хорошими метриками на трейне также продемнострирует хорошие метрики на тесте
- *связь предикторов с целевой переменной*: на трейне мы наблюдали:
    - ожидаемую положительную корреляцию между целевой переменной `selling_price` и признаком `year` (чем машина новее, тем выше цена)
    - положительную корреляцию между целевой переменной `selling_price` и признаками-характеристиками двигателя `engine`, `max_power` и `torque` (чем больше объем двигателя, максимальная мощность и крутящий момент, тем выше цена)
    - ожидаемую отрицательную корреляцию между целевой переменной `selling_price` и признаком `km_driven` (чем выше пробег, тем ниже цена)
- *корреляция признаков между собой*: на трейне мы наблюдали:
    - ожидаемую положительную корреляцию между признаками-характеристиками двигателя `engine`, `max_power` и `torque`
    - ожидаемую отрицательную корреляцию между признаками-характеристиками двигателя `engine`, `max_power` и `torque` и признаком `mileage` (чем мощнее машина, тем меньше расстояние, которое она может проехать на фиксированном количестве топлива)
прочие выводы: то обстоятельство, что признаки-характеристики двигателя `engine`, `max_power` и `torque` положительно коррелируют между собой и с целевой переменной `selling_price`, указывает на целесообразность применения регуляризации

### Тепловая карта попарных корреляций признаков и целевой переменной

- признаки `year` и `engine` наимене скоррелированы между собой: значение корреляции между ними примерно равно нулю
- если не учитывать целевую переменную, довольно сильная положительная линейная зависимость наблюдается между парами признаков:
    - `engine` и `max_power` (0.68)
    - `torque` и `max_power` (0.67)
    - `engine` и `seats` (0.65)
    - `engine` и `torque` (0.61)
- если опираться только на данные тепловой карты, между признаками `year` и `km_driven` наблюдается отрицательная линейная зависимость (-0.37). Если же дополнительно изучить график попарных распределений числовых признаков, то все становится не так однозначно: для машин не страше 2010 года зависимость отрицательная (чем меньше год, тем меньше проеханных киломентов), для машин старше — положительная (чем меньше год, тем меньше проеханных километров)

### Графики оценки распределения ядра и диаграммы размаха

- распределения большинства количественных признаков и целевой переменной или сильно (в отдельных случаях экстремально) смещены, или вообще не напоминают нормальное распределени (например, распределение признака `max_torque_rpm` больше напоминает мультимодальное распредление); стоит подумать об их нелинейном преобразовании
- в значениях большинства количественных признаков и целевой переменной много выбросов; стоит подумать о способах снижения их влияния

## 3. ML-этап

На данном этапе мы обучили четыре линейных модели:

-  `LinearRegression`-модель — только на числовых признаках (до и после стандартизации) на дефолтных параметрах
- `Lasso`-модель — только на числовых признаках (после стандартизации) на дефолтных параметрах и с подбором гиперпараметра `alpha` при помощи `GridSearch`
- `ElasticNet`-модель — только на числовых признаках (после стандартизации) с подбором гиперпараметров `alpha` и `l1_ratio` при помощи `GridSearch`
- `Ridge`-модель — на числовых (после стандартизации) и категориальных (после `OneHotEncoding`) признаках с подбором гиперпараметра `alpha` при помощи `GridSearch`

Мы установили:

- лучшие значения метрик `r2` и `MSE` на трейне и тесет показала `Ridge`-модель, обученная на числовых и категориальных признаков
- в результате подбора гиперпараметра `alpha` `Lasso`-модель занулила веса трех количественных признаков `mileage`, `engine` и `torque` 

## 4. Feature Engineering

На данном этапе мы постарались улучшить значения метрик за счет работы с признаками. 

Мы двигались в трех направлениях:

1. Обработка существующих признаков
2. Генерация новых признаков на основе существующих признаков
3. Создание новых признаков

Мы сравнивали наши эксперименты по метрике `r2` c baseline — `r2` `LinearRegression`-модели на дефолтных параметрах, обученная на числовых (после стандартизации) и категориальных (после `OneHotEncoding`) признаках (0.62).
Для оценки качества наших экспериментов мы использовали кросс-валидацию на 10 фолдах.

### Обработка существующих признаков

В рамках данного направления мы:

- логарифмировали значения признаков `km_driven`, `engine`, `torque` и `max_torque_rpm`
- логарифмировали значение целевой переменной `selling_price`
- ограничили значения признаков `year`, `km_driven`, `mileage`, `engine`, `torque`, `max_torque_rpm` 0.5 и 99.5 персентилями

### Генерация новых признаков на основе существующих признаков

В рамках данного направления мы добавили полиномиальные признаки второй степени.

### Создание новых признаков

В рамках данного направления мы создали новый категориальный признак — марку машины, полученную из данных признака `name` — и закодировали его при помощи `OneHotEncoding`.


Наибольший прирост качества продемонстировали логарифмирование целевой переменной (0.81), добавление полиномиальных признаков (0.73) и категориального признака - марки машины (0.71).
При комбинировании линейных моделей и отдельных экспериментов лучший результат на трейне показала комбинация из логарифмирования целевой переменной, добавления категориального признака - марки машины и `Ridge`- модели (0.86).

При наличии дополнительного времени стоит дополнительно протестировать: 

- заполнение пропусков предсказаниями обученной модели
- получение признака класс автомобиля

Лучшая модель показала на тесте `r2` 0.88 (0.92 на копиях исходных датасетов до удаления дубликатов) и бизнес-метрику 0.35.

Для деплоймента мы упаковали модель и препроцессинг (базовый и feature engineering) в единый пайплайн, который предсказывает стоимость на исходных данных.

## 5. Разработка и тестирование веб-сервиса

На данном этапе мы разработали и протестировали веб-сервис.

